# Pre-Release CRAN Check
# Extra-strict CRAN checks for final verification before submission
# Run manually before submitting to CRAN

name: pre-release-check

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  pre-release:
    runs-on: ${{ matrix.config.os }}
    
    name: Pre-Release (${{ matrix.config.os }}, R-${{ matrix.config.r }})
    
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: macOS-latest,   r: 'release'}
          - {os: windows-latest, r: 'release'}
          - {os: windows-latest, r: 'devel'}
          - {os: ubuntu-latest,  r: 'devel'}
          - {os: ubuntu-latest,  r: 'release'}
          - {os: ubuntu-latest,  r: 'oldrel-1'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes
      _R_CHECK_CRAN_INCOMING_: true
      _R_CHECK_CRAN_INCOMING_REMOTE_: true
      _R_CHECK_FORCE_SUGGESTS_: false

    steps:
      - uses: actions/checkout@v4

      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::rcmdcheck
            any::urlchecker
            any::spelling
          needs: check

      - name: Setup LaTeX
        if: runner.os != 'Windows'
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y texlive-latex-base texlive-fonts-recommended texlive-fonts-extra texlive-latex-extra
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew install --cask basictex
            eval "$(/usr/libexec/path_helper)"
            sudo tlmgr update --self
            sudo tlmgr install collection-latexrecommended
          fi
        shell: bash

      - name: Check URLs
        run: |
          urlchecker::url_check()
        shell: Rscript {0}

      - name: Check spelling
        run: |
          spelling::spell_check_package()
        shell: Rscript {0}

      - name: R CMD check (strict CRAN mode)
        uses: r-lib/actions/check-r-package@v2
        with:
          upload-snapshots: true
          args: 'c("--as-cran", "--no-manual")'
          build_args: 'c("--compact-vignettes=gs+qpdf")'
          error-on: '"error"'

      - name: Check package size
        run: |
          pkg_tarball <- list.files(pattern = "\\.tar\\.gz$", full.names = TRUE)
          if (length(pkg_tarball) > 0) {
            size_mb <- file.size(pkg_tarball) / 1024^2
            cat(sprintf("Package size: %.2f MB\n", size_mb))
            if (size_mb > 5) {
              warning(sprintf("Package size (%.2f MB) exceeds CRAN's 5 MB soft limit", size_mb))
            }
          }
        shell: Rscript {0}

      - name: Upload check results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pre-release-${{ runner.os }}-r${{ matrix.config.r }}-results
          path: check
